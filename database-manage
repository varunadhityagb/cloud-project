#!/bin/bash

# Collection of database management utilities

NAMESPACE="carbon-profiling"
DB_POD=""

# Function to get PostgreSQL pod
get_db_pod() {
    DB_POD=$(kubectl get pods -n "$NAMESPACE" -l app=postgres -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
    if [ -z "$DB_POD" ]; then
        echo "âŒ Error: PostgreSQL pod not found"
        exit 1
    fi
}

# Function: Show database statistics
show_stats() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Database Statistics"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    get_db_pod

    echo "ğŸ“Š Device Metrics:"
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        SELECT
            COUNT(*) as total_records,
            COUNT(DISTINCT device_id) as unique_devices,
            MIN(timestamp) as first_record,
            MAX(timestamp) as last_record,
            pg_size_pretty(pg_total_relation_size('device_metrics')) as table_size
        FROM device_metrics;
    "

    echo ""
    echo "ğŸŒ± Carbon Footprints:"
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        SELECT
            COUNT(*) as total_records,
            ROUND(SUM(total_carbon_gco2)::numeric, 2) as total_carbon_g,
            ROUND(AVG(grid_intensity_gco2_per_kwh)::numeric, 2) as avg_grid_intensity,
            pg_size_pretty(pg_total_relation_size('carbon_footprints')) as table_size
        FROM carbon_footprints;
    "

    echo ""
    echo "ğŸ’¾ Database Size:"
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        SELECT pg_size_pretty(pg_database_size('carbon_metrics')) as database_size;
    "
}

# Function: Backup database
backup_db() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Database Backup"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    get_db_pod

    BACKUP_FILE="carbon_metrics_backup_$(date +%Y%m%d_%H%M%S).sql"

    echo "ğŸ“¦ Creating backup: $BACKUP_FILE"

    kubectl exec -n "$NAMESPACE" "$DB_POD" -- pg_dump -U carbon_user carbon_metrics > "$BACKUP_FILE"

    if [ -f "$BACKUP_FILE" ]; then
        SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
        echo "âœ… Backup created successfully"
        echo "   File: $BACKUP_FILE"
        echo "   Size: $SIZE"
    else
        echo "âŒ Backup failed"
        exit 1
    fi
}

# Function: Restore database
restore_db() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Database Restore"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    if [ -z "$1" ]; then
        echo "âŒ Error: No backup file specified"
        echo ""
        echo "Usage: $0 restore <backup_file.sql>"
        echo ""
        echo "Available backups:"
        ls -lh carbon_metrics_backup_*.sql 2>/dev/null || echo "  (none found)"
        exit 1
    fi

    BACKUP_FILE="$1"

    if [ ! -f "$BACKUP_FILE" ]; then
        echo "âŒ Error: Backup file not found: $BACKUP_FILE"
        exit 1
    fi

    get_db_pod

    echo "âš ï¸  WARNING: This will overwrite the current database!"
    echo "   Backup file: $BACKUP_FILE"
    echo ""
    read -p "Continue? (yes/no): " confirm

    if [ "$confirm" != "yes" ]; then
        echo "Cancelled."
        exit 0
    fi

    echo ""
    echo "ğŸ“¥ Restoring database from $BACKUP_FILE..."

    cat "$BACKUP_FILE" | kubectl exec -i -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user carbon_metrics

    echo "âœ… Database restored successfully"
}

# Function: Clear all data
clear_data() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Clear Database Data"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    get_db_pod

    echo "âš ï¸  WARNING: This will delete ALL data from the database!"
    echo "   Tables will be preserved, but all records will be deleted."
    echo ""
    read -p "Are you sure? Type 'DELETE ALL DATA' to confirm: " confirm

    if [ "$confirm" != "DELETE ALL DATA" ]; then
        echo "Cancelled."
        exit 0
    fi

    echo ""
    echo "ğŸ—‘ï¸  Deleting all data..."

    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        TRUNCATE TABLE carbon_footprints, device_metrics CASCADE;
    "

    echo "âœ… All data deleted"
    echo "   Database schema preserved"
}

# Function: Show recent records
show_recent() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Recent Records"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    get_db_pod

    LIMIT=${1:-10}

    echo "ğŸ“Š Last $LIMIT Device Metrics:"
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        SELECT
            device_id,
            timestamp,
            ROUND(total_power_watts::numeric, 2) as power_w,
            ROUND(cpu_percent::numeric, 1) as cpu_pct,
            city,
            country
        FROM device_metrics
        ORDER BY timestamp DESC
        LIMIT $LIMIT;
    "

    echo ""
    echo "ğŸŒ± Last $LIMIT Carbon Footprints:"
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        SELECT
            device_id,
            timestamp,
            ROUND(operational_carbon_gco2::numeric, 4) as operational_g,
            ROUND(embodied_carbon_gco2::numeric, 4) as embodied_g,
            ROUND(total_carbon_gco2::numeric, 4) as total_g,
            ROUND(grid_intensity_gco2_per_kwh::numeric, 2) as grid_intensity
        FROM carbon_footprints
        ORDER BY timestamp DESC
        LIMIT $LIMIT;
    "
}

# Function: Connect to database shell
db_shell() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   PostgreSQL Interactive Shell"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ’¡ Tips:"
    echo "   \\dt           - List tables"
    echo "   \\d table_name - Describe table"
    echo "   \\q            - Exit"
    echo ""

    get_db_pod

    kubectl exec -it -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics
}

# Function: Export data to CSV
export_csv() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Export Data to CSV"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    get_db_pod

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    METRICS_FILE="device_metrics_${TIMESTAMP}.csv"
    CARBON_FILE="carbon_footprints_${TIMESTAMP}.csv"

    echo "ğŸ“¤ Exporting device metrics..."
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        COPY (SELECT * FROM device_metrics ORDER BY timestamp) TO STDOUT WITH CSV HEADER
    " > "$METRICS_FILE"

    echo "ğŸ“¤ Exporting carbon footprints..."
    kubectl exec -n "$NAMESPACE" "$DB_POD" -- psql -U carbon_user -d carbon_metrics -c "
        COPY (SELECT * FROM carbon_footprints ORDER BY timestamp) TO STDOUT WITH CSV HEADER
    " > "$CARBON_FILE"

    echo ""
    echo "âœ… Export complete:"
    echo "   ğŸ“„ $METRICS_FILE ($(du -h "$METRICS_FILE" | cut -f1))"
    echo "   ğŸ“„ $CARBON_FILE ($(du -h "$CARBON_FILE" | cut -f1))"
}

# Main menu
show_menu() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   Database Management Utilities"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  stats              Show database statistics"
    echo "  recent [n]         Show recent N records (default: 10)"
    echo "  backup             Create database backup"
    echo "  restore <file>     Restore from backup file"
    echo "  clear              Clear all data (keep schema)"
    echo "  shell              Open PostgreSQL interactive shell"
    echo "  export             Export data to CSV files"
    echo ""
    echo "Examples:"
    echo "  $0 stats"
    echo "  $0 recent 20"
    echo "  $0 backup"
    echo "  $0 restore carbon_metrics_backup_20250101_120000.sql"
    echo "  $0 shell"
    echo ""
}

# Main script logic
case "${1:-menu}" in
    stats)
        show_stats
        ;;
    recent)
        show_recent "${2:-10}"
        ;;
    backup)
        backup_db
        ;;
    restore)
        restore_db "$2"
        ;;
    clear)
        clear_data
        ;;
    shell)
        db_shell
        ;;
    export)
        export_csv
        ;;
    menu|help|-h|--help)
        show_menu
        ;;
    *)
        echo "âŒ Unknown command: $1"
        echo ""
        show_menu
        exit 1
        ;;
esac
